<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>리뷰작성</title>

    <link href="/resources/css/common.css" rel="stylesheet" type="text/css"/>
    <link href="/resources/css/style.css" rel="stylesheet" type="text/css"/>
    <link rel="preconnect" href="https://fonts.gstatic.com"/>
   
    <script src="https://use.fontawesome.com/releases/v5.2.0/js/all.js"></script>
    <style>
          #star a{
            text-decoration: none;
            color: gray;
            }
            #star a.on{
            color: red;
            } 
    </style>
</head>
<body>
<header>
    <button class="back_btn"></button>
    <span class="title">리뷰작성</span>
</header>
<div class="contents_wrap" style="padding-bottom: 0px; overflow: scroll;">
    <P id="star"> <!-- 부모 -->
        <a href="#" value="1">★</a> <!-- 자식들-->
        <a href="#" value="2">★</a>
        <a href="#" value="3">★</a>
        <a href="#" value="4">★</a>
        <a href="#" value="5">★</a>
    <p>
    <div class="restaurant_name_wrap" id="restaurant_name"></div>
    <div style="margin-bottom: 30px; font-weight: 600;">
        식사는 맛있게 하셨나요?
    </div>
    <div id="myform">
        <fieldset>
            <input type="checkbox" name="rating" value="5" id="rate1"><label for="rate1">⭐</label>
            <input type="checkbox" name="rating" value="4" id="rate2"><label for="rate2">⭐</label>
            <input type="checkbox" name="rating" value="3" id="rate3"><label for="rate3">⭐</label>
            <input type="checkbox" name="rating" value="2" id="rate4"><label for="rate4">⭐</label>
            <input type="checkbox" name="rating" value="1" id="rate5"><label for="rate5">⭐</label>
            <input type="hidden" id="star_cnt">
        </fieldset>
    </div>

    <div class="review_write">
        <p style="font-weight: 600;">리뷰를 작성해 주세요</p>
        <textarea class="review_write_wrap" id="review_content" placeholder="만족도에 대한 후기를 남겨주세요."></textarea>
         <!-- <div class="" id="btn_gallery" style="border:1px solid #dddddd; padding:12px; width:100%;margin-bottom:20px; display: flex; justify-content: center;">
            <img src="/resources/images/icon-gallery.png"><span style="margin-left: 8px;">사진 첨부하기</span>
        </div> -->
        <!-- <input class="form-control-file" id="inputFile" name="files[]" type="file" multiple>
        
        <br>  -->
        <label class="input-file-button" for="input-file">
            <img src="/resources/images/icon-gallery.png"><span style="margin-left: 8px;">사진 첨부하기</span>
        </label>
        <input type="file" name="files[]" id="input-file" style="display: none;" multiple/>
        <div id="img_thumbnail" class="img_thumbnail_wrap">
    
        </div>
        
    </div>

   
    
</div>
<button type="button" class="bottom_btn bg_color_mint" id="btnUpload">저장</button>

<script type="text/javascript" src="/resources/js/jquery-3.5.1.min.js"></script>
<script type="text/javascript" src="/resources/js/handlebars-4.0.11.js"></script>
<script type="text/javascript" src="/resources/js/axios.min.js"></script>
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

<script type="module">
    import {
        callAxios,
        ajaxConnect,
        _BASE_URL,
        popup,
        popupHide,
        toBase64,
        showModal
    } from "../../resources/js/common.js";
     var getParameters = function (paramName) {
        return localStorage.getItem(paramName);
    };

    $('input:checkbox[name="rating"]').on('change',function(){
        console.log($(this).val());
    });


    $('#input-file').on('change',function(){

        var reader = new FileReader();

        reader.onload = function (e) {
            // get loaded data and render thumbnail.
            //alert(e.target.result);
            $("#img_thumbnail").append('<img src =' + e.target.result + '>');
         //document.getElementById("image").src = e.target.result;
        };

        // read the image file as a data URL.
        reader.readAsDataURL(this.files[0]);
    });

    let v = {
        targetId:  getParameters('id'),
        memberId: sessionStorage.getItem('_memberId'),
        fileList: []
    }
    // alert(v.memberId);
    $(function () {
        alert(getParameters('id'));
        $('#restaurant_name').text(getParameters('name'));
    });
    const common = {
        goMain: function () {
            location.href = '../lunch_main.html'
        },
        verify: function (data) {
            return !!($('#review_content').val().trim());
        },
        emailCheck: function (email) {
            const regex = /([\w-.]+)@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([\w-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(]?)$/;
            console.log('email check')
            return !!(email !== '' && email !== 'undefined' && regex.test(email));
        }
    }

    const fn = {
        saveReview: function () {
            const params = {
                contents: $('#review_content').val(),
                memberId : sessionStorage.getItem('_memberId'),
                menuId : getParameters('id'),
                star : 4
            }
            if (common.verify(params)) {
                alert("!")
                axios.post('/menu/registerReview', JSON.stringify(params),
                    {headers: {'Content-Type': `application/json`}}
                ).then(response => {
                    console.log(response)
                    
                    // axios.defaults.headers.common['Authorization'] = `Bearer ${_accessToken}`
                    alert('리뷰가 등록되었습니다.')
                    return;
                }).catch(error => {
                    if (error.response.status === 401) {
                        alert('리뷰를 등록하는 도중 오류가 발생했습니다.')
                    }
                })
            }
        },
        /**
         * 파일 업로드
         * @return {boolean}
         */
         upload: function () {
            // 파일 파라미터 준비
            let formData = new FormData()
            const target = document.getElementsByName('files[]')
            // target[0]인 이유는 getElementsByName 하면 리스트로 받아옴
            Array.prototype.push.apply(v.fileList, target[0].files)

            console.log(v.fileList)
            // 서버에서는 항상 여러 파일로 받아옴
            for (let i = 0; i < v.fileList.length; i++) {
                // files 이름으로 업로드할 파일들 추가
                formData.append('files', v.fileList[i])
            }
            // targetId: 메뉴 id(Long) 받아와서 넣기 !!
            formData.append('targetId', v.targetId)
            // memberId: 로그인 유저 id(Long) 받아와서 넣기 !! (로그인 아이디 아님)
            formData.append('memberId', v.memberId)

            // 파일 없을 경우 그냥 리턴
            if (!formData.has('files')) {
                console.log('No File Check')
                return false
            }
            // 업로드 api 호출
            axios.post('/file/upload', formData,
                {header: {'Content-Type': `multipart/form-data`}}
            ).then(response => {
                console.log('upload_response' + response)
                // 업로드가 되었으면 리스트 다시 그리기
                if (response.status === 200) {
                    // fn.getFileList()
                } else {
                    alert('파일업로드를 실패했습니다.')
                }
            }).catch(error => {
                console.log(error)
                console.log(error.response)
            })
        },
        /**
         * 이미지 다운로드
         * @param fileKey
         */
        download: function (fileKey) {
            // 파라미터 이름은 fileKey
            const params = {
                fileKey: fileKey
            }
            // responseType: blob
            axios.post('/file/downloadFile', params,
                {
                    header: {
                        'Content-Type': `application/json`
                    },
                    responseType: 'blob'
                }
            ).then(response => {
                // FileReader를 통해 blob 형식 파일 읽기
                let reader = new FileReader()
                let imgRaw = response.data

                reader.readAsDataURL(response.data)

                // reader의 onload event 발생했을 때 이미지 태그 찾아 집어 넣기
                reader.onload = () => {
                    imgRaw = reader.result
                    $('[data-file="' + fileKey + '"]')
                    .append('<img alt="" src="' + imgRaw + '" width="100%">')
                }
            }).catch(error => {
                console.log(error)
                console.log(error.response)
            })
        },
        /**
         * 파일 리스트 가져오기
         */
        getFileList: function () {
            // targetId는 메뉴 아이디! Long 타입임
            const params = {
                targetId: v.targetId
            }
            // getFileList api 호출
            axios.post(
                '/file/getFileList',
                JSON.stringify(params),
                {headers: {'Content-Type': `application/json`}}
            ).then(response => {
                v.fileList = response.data.data
                // 파일 리스트가 있을 경우에만 리스트 그리기
                if (v.fileList) {
                    fn.drawList()
                } else {
                    console.log('file list is empty')
                }
            }).catch(error => {
                console.log(error)
                console.log(error.response)
            })
        },
        /**
         * List 그리기 함수
         */
        drawList: function () {
            if (v.fileList) {
                const files = v.fileList
                let $fileList = $('#fileList')
                for (let i = 0; i < files.length; i++) {
                    let file = files[i]
                    // fileKey: 파일이 저장된 이름
                    // fileName: 저장한 파일의 실제 이름
                    $fileList.append(
                        '<li data-file="' + file.fileKey + '"'
                        + ' class="file-item list-group-item">'
                        + file.fileName
                        + '</li>'
                    )
                    // 파일 다운로드까지 추가
                    fn.download(file.fileKey)
                }
            }
        }
    }

    $('#star a').click(function(){ 
	 $(this).parent().children("a").removeClass("on");    
	 $(this).addClass("on").prevAll("a").addClass("on");
	 console.log($(this).attr("value"));
 });
   
    $('#btnUpload').on('click',function(){
        var msg = "리뷰를 등록하시겠습니까?";
        if (confirm(msg) != 0) {
            // fn.saveReview();
            fn.upload();//사진등록먼저
        }
    });

    $('#btn_save').on('click', function () {
        var p_address = $('#address').val();
        var p_name = $('#restaurant').val();
        var p_type = $('#typeName').val();

        if (p_address == '' || p_name == '' || p_type == '') {
            alert('내용을 입력해주세요.');
            return;
        }

        var addMenuData = {};
        addMenuData = {"location": p_address, "menuType": p_type, "name": p_name};

        var msg = "메뉴를 추가하시겠습니까?";
        if (confirm(msg) != 0) {
            // Yes click
            var callback = ajaxConnect('POST', 'addMenu', addMenuData);
            // $('#loading_container').show();

            if (callback.xhr == '200') {
                //$('#loading_container').hide();
                alert('메뉴가 추가되었습니다.');
                location.href = 'lunch_main.html';
            } else if (callback.error !== undefined) {
                $('#loading_container').hide();
                alert(callback.errMsg);
            }

        } else {
            // no click
        }

    });
    //좌측 상단 뒤로가기 버튼
    $('.back_btn').on('click', function () {
        window.history.back();
    });
</script>
</body>
</html>
