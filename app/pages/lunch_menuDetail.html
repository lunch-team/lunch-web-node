<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>점심 뭐 먹지?</title>

    <link href="/resources/css/common.css" rel="stylesheet" type="text/css"/>
    <link href="/resources/css/style.css" rel="stylesheet" type="text/css"/>
    <link rel="preconnect" href="https://fonts.gstatic.com"/>
    <script src="https://use.fontawesome.com/releases/v5.2.0/js/all.js"></script>
</head>
<body>
<header>
    <button class="back_btn"></button>
    <span class="title">메뉴 상세</span>
</header>
<div class="contents_wrap">
    <ul>
        <li class="restaurant_name">
            <span id="restaurant" name="nm"></span>
            <span id="btn_more"><img src="../resources/images/option.png" width="24px"></span>
        </li>
        <li class="restaurant_address">
            <span id="address" name="nm"></span>
            <!-- <div class="search">
                <input type="text" id="address" name="nm"/>
                <button type="button" style="float: right; line-height: 50px;">
                    <i class="fas fa-search fa-xs" onclick="findAddr()"></i>
                </button>
            </div> -->
        </li>
        <li class="restaurant_review">
            <span>⭐4.8</span>
            <span>리뷰 12</span>
            <span id="btn_review_detail">리뷰작성</span>
        </li>
        <li class="restaurant_location">
            <span id="location"></span>
        </li>
        
    </ul>

    <!--팝업-->
    <div class="more_menu">
        <span id="btn_delete">삭제하기</span><br>
        <span id="btn_save">수정하기</span><br>
        <span id="btn_add">방문추가</span>
    </div>
    <div class="dimmed"></div>
   
</div>

<div class="div_line">
</div>

<!--리뷰 리스트-->
<div class="review_list_wrap">
    <div class="review_count">
        <span>리뷰</span>
        <span>81개</span>
    </div>
    <div>
        <span id="review_content"></span>
    </div>
</div>

<script type="text/javascript" src="/resources/js/jquery-3.5.1.min.js"></script>
<script type="text/javascript" src="/resources/js/handlebars-4.0.11.js"></script>
<script type="text/javascript" src="/resources/js/axios.min.js"></script>
<script type="text/javascript" src="/resources/js/common.js"></script>
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

<script id="selectMenuType" type="text/x-handlebars-template">
    {{#menuType}}
    <option value="{{menuType}}">{{menuName}}</option>
    {{/menuType}}
</script>


<script type="module">
    import {
        callAxios,
                ajaxConnect,
        _BASE_URL,
        popup,
        popupHide,
        toBase64,
        showModal
    } from "../resources/js/common.js";
        var getParameters = function (paramName) {
        return localStorage.getItem(paramName);
    };
    
    const common = {
        goMain: function () {
            location.href = '../lunch_main.html'
        },
        verify: function (data) {
            return !!(getParameters('id').trim());
        },
        emailCheck: function (email) {
            const regex = /([\w-.]+)@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([\w-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(]?)$/;
            console.log('email check')
            return !!(email !== '' && email !== 'undefined' && regex.test(email));
        }
    }

    const fn = {
        saveReview: function () {
            const params = {
                menuId : getParameters('id')
            }
            if (common.verify(params)) {
                alert("!")
                axios.post('/menu/getReviewList', JSON.stringify(params),
                    {headers: {'Content-Type': `application/json`}}
                ).then(response => {
                    console.log(response)
                    
                    // axios.defaults.headers.common['Authorization'] = `Bearer ${_accessToken}`
                    alert('리뷰가져오기 성공.')
                    return;
                }).catch(error => {
                    if (error.response.status === 401) {
                        alert('리뷰를 가져오는 도중 오류가 발생했습니다.')
                    }
                })
            }
        }
    }

    $(function () {
        if (!getParameters('id')) {
            location.href = 'lunch_allMenuList.html';
        }
        var callback = ajaxConnect('GET', 'getMenuType', '');

        if (callback.data != undefined) {
            var obj = callback.data;
            var source = $("#selectMenuType").html();
            var template = Handlebars.compile(source);
            var res = {
                menuType: obj.data
            };

            var html = template(res);
            $("#typeName").append(html);
        }

        $('#restaurant').text(getParameters('name'));
        $('#address').text(getParameters('location'));
        $('#typeName').val(getParameters('type'));
    });

    $('#btn_review_detail').on('click',function(){
        location.href = 'lunch_reviewWrite.html';
    });

    $('#btn_save').on('click', function () {
        var msg = "수정하시겠습니까?";
        if (confirm(msg) != 0) {
            var p_address = $('#address').val();
            var p_name = $('#restaurant').val();
            var p_type = $('#typeName').val();
            var p_id = getParameters('id');

            if (p_address == '' || p_name == '' || p_type == '') {
                alert('내용을 입력해주세요.');
                return;
            }

            var modifyData = {};
            modifyData = {"id": p_id, "location": p_address, "menuType": p_type, "name": p_name};
            var callback = ajaxConnect('POST', 'modifyMenu', modifyData);
            console.log(JSON.stringify(callback))

            if (callback.xhr == '204') {
                alert('수정되었습니다.');
                location.href = 'lunch_allMenuList.html';
            } else if (callback.error != undefined) {
                alert(callback.errMsg);
            }
        }
    });

    $('#btn_delete').on('click', function () {
        var msg = "삭제하시겠습니까?";
        showModal('2', '삭제하시겠습니까?');
        return;
        if (confirm(msg) != 0) {
            var p_id = getParameters('id');

            var deleteParam = {};
            deleteParam = {"id": p_id};
            var callback = ajaxConnect('POST', 'deleteMenu', deleteParam);
            console.log(JSON.stringify(callback))

            if (callback.xhr == '204') {
                alert('삭제되었습니다.');
                location.href = 'lunch_allMenuList.html';
            } else if (callback.error != undefined) {
                alert(callback.errMsg);
            }
        }
    });

    $('#btn_add').on('click', function () {

        var msg = "추가하시겠습니까?";
        if (confirm(msg) != 0) {
            // Yes click
            var addData = {};
            addData = {"id": getParameters('id')};
            var callback = ajaxConnect('POST', 'visitMenu', addData);
            console.log(JSON.stringify(callback));

            //성공
            if (callback.data != undefined) {
                alert('추가되었습니다.');
                location.href = 'lunch_allMenuList.html';
            } else if (callback.error != undefined) { //실패
                alert(callback.errMsg);
            }
        } else {
            // no click
        }
    });

    $('#btn_more').on('click', function(){
        $('.more_menu').css('display','block');
        $('.dimmed').css('display','block');
    });
    // 58.181.28.53:11199/menu/getAllMenu(GET) // addMenu(POST)

    $(document).mouseup(function (e){
        var LayerPopup = $(".more_menu");
        console.log(LayerPopup.has(e.target))
        if(!(LayerPopup.has(e.target).length)) {
            LayerPopup.css('display','none');
            $('.dimmed').css('display','none');
        }
    });

    //좌측 상단 뒤로가기 버튼
    $('.back_btn').on('click', function () {
        window.history.back();
    });
</script>


</body>
</html>
